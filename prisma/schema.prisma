// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String        @id @default(uuid())
  email       String        @unique
  name        String
  password    String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  groups      Group[]       // A user can create many groups
  memberships GroupMember[] // A user can be a member of many groups
  topics      Topic[]       // ADD THIS LINE: A user can create many topics
}

model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique
  // REMOVED: members GroupMember[] - managed via GroupMember.role string and DB foreign key
}

model Group {
  id          String        @id @default(uuid())
  name        String        @unique
  description String?
  isPrivate   Boolean       @default(false)
  createdBy   String // Foreign key to User
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  creator     User          @relation(fields: [createdBy], references: [id])
  members     GroupMember[] // A group can have many members (crucial for nested create)
  topics      Topic[]       // A group can have many topics
}

model GroupMember {
  id          String   @id @default(uuid())
  userId      String
  groupId     String
  role        String   @default("MEMBER") // This will store the role name (e.g., 'CREATOR', 'ADMIN', 'MEMBER')
  permissions Json     @default("{}") // JSONB type in Postgres
  joinedAt    DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId]) // Composite unique key
  @@index([role]) // Add an index for efficient lookups by role if needed
}

model Topic {
  id        String   @id @default(uuid())
  title     String
  groupId   String
  createdBy String
  createdAt DateTime @default(now())

  group     Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  creator   User  @relation(fields: [createdBy], references: [id]) // Creator is a User
}
